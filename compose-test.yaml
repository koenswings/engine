# This file is used by Docker Dev Environment to create the dev container
services:
  engine:
    # Infinite loop to keep the container running - use when you don't have a server running
    # entrypoint:
    # - sleep
    # - infinity
    build: 
      context: .
      target: base
    init: true
    restart: always

    # Configuration to anble the ability to mount USB devices
    privileged: true 
    # devices:
    #   - "/dev/bus/usb:/dev/bus/usb"
      #- "/dev/usb:/dev/usb"
      #- "/dev:/dev"
    # cap_add:
    #   - SYS_ADMIN

    # The test machine must run in host mode in order to detect connects and disconnects to the nework interfaces of the host
    network_mode: "host"        
    # ports:
    #   - "1234:1234"  # Yjs websocket
    #   - "22:5123"    # SSH
    volumes:
      - type: bind
        source: /var/run/docker.sock
        target: /var/run/docker.sock
      - type: bind
        source: .
        target: /engine
      - type: bind  # Required to see newly added USB devices
        source: /dev
        target: /dev
    command: bash -c "cd /engine && npm config set prefer-offline=true && pnpm run install_packages && pnpm run dev" 

