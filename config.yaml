settings:
  mdns: true
  isDev: true
  port: 4321
  storeDataFolder: store-data
  storeIdentityFolder: store-identity
defaults:
  user: pi
  machine: raspberrypi.local
  password: raspberry
  engine: 127.0.0.1
  network: appnet
  language: en_ZW.UTF-8
  keyboard: us
  timezone: Europe/Brussels
  upgrade: false
  hdmi: false
  temperature: true
  argon: true
  zerotier: false
  raspap: false
  gadget: true
  nodocker: true   # Whether the engine itself will be dockerized
  gitAccount: koenswings
testSetup:
  resetBeforeTest: true
  engines:
    - name: "engine-1"
      hostname: "engine-1.local"
    - name: "engine-2"
      hostname: "engine-2.local"
  disks:
    - diskId: "disk-A-kiwix"
      type: "AppDisk"
      instances:
        - instanceName: "kiwix-main"
          appName: "kiwix"
          version: "latest"
          title: "Kiwix"
    - diskId: "disk-B-kolibri"
      type: "AppDisk"
      instances:
        - instanceName: "kolibri-main"
          appName: "kolibri"
          version: "latest"
          title: "Kolibri"
    - diskId: "disk-C-nextcloud"
      type: "AppDisk"
      instances:
        - instanceName: "nextcloud-main"
          appName: "nextcloud"
          version: "latest"
          title: "Nextcloud"

  interactiveTestSequence:
    - stage: 1
      description: "Provision engine-1."
      manualInstruction: "Flash a new SD card with Raspberry Pi OS Lite (64-bit) and power it on as the ONLY new device on the network at raspberrypi.local. Press Enter to begin provisioning."
      action:
        type: "runCommand"
        command: "buildEngine \"--machine raspberrypi.local --hostname engine-1\""
      assert: []

    - stage: 2
      description: "Boot engine-1 and connect to it."
      manualInstruction: "The provisioning of engine-1 is complete and it has rebooted. Wait for it to come online at engine-1.local, then press Enter."
      action:
        type: "runCommand"
        command: "connect engine-1"
      assert:
        - { description: "One engine should be online.", path: "engineDB", should: "have.lengthOf(1)" }

    - stage: 3
      description: "Prepare Kiwix App Disk on engine-1."
      manualInstruction: "Attach a blank, ext4-formatted USB drive to engine-1. Wait for it to be detected (you can use 'ls disks' in a separate client to find its generated ID, e.g., 'disk-xxxxxxxx'), then press Enter."
      action: null
      assert:
        - { description: "A new disk should be detected on the network.", path: "diskDB", should: "have.lengthOf(1)" }

    - stage: 4
      description: "Create the Kiwix instance on the new disk."
      manualInstruction: null
      action:
        type: "sendCommand"
        targetEngineName: "engine-1"
        command: "createInstance kiwix-main kiwix koenswings latest disk-A-kiwix"
      assert:
        - { description: "The Kiwix instance should be created.", path: "find(instanceDB, { name: 'kiwix-main' })", should: "not.equal(undefined)" }

    - stage: 5
      description: "Disconnect from all engines to prepare for engine-2."
      manualInstruction: "Press Enter to disconnect the test client."
      action:
        type: "runCommand"
        command: "disconnect"
      assert:
        - { description: "Test client should be disconnected.", path: "system.isConnected", should: "equal(false)" }

    - stage: 6
      description: "Provision engine-2."
      manualInstruction: "Take engine-1 OFFLINE. Flash a new SD card for engine-2 and power it ON at raspberrypi.local. Press Enter to begin provisioning."
      action:
        type: "runCommand"
        command: "buildEngine \"--machine raspberrypi.local --hostname engine-2\""
      assert: []

    - stage: 7
      description: "Boot both engines and connect."
      manualInstruction: "Provisioning of engine-2 is complete. Insert the SD cards into their respective Pis and power ON both engine-1 and engine-2. Wait for them to boot, then press Enter."
      action:
        type: "runCommand"
        command: "connect engine-1 engine-2"
      assert:
        - { description: "Two engines should be online.", path: "engineDB", should: "have.lengthOf(2)" }

  automatedTestSequence:
    - stage: 1
      description: "Connect to the predefined testbed of two engines."
      manualInstruction: "ASSUMPTION: Both engine-1 and engine-2 are running with their respective disks attached."
      action:
        type: "runCommand"
        command: "connect engine-1 engine-2"
      assert:
        - { description: "Two engines should be present.", path: "engineDB", should: "have.lengthOf(2)" }
        - { description: "Three instances should be present.", path: "instanceDB", should: "have.lengthOf(3)" }

    - stage: 2
      description: "Stop the Nextcloud instance via command."
      manualInstruction: null
      action:
        type: "sendCommand"
        targetEngineName: "engine-2"
        command: "stopInstance nextcloud-main disk-C-nextcloud"
      assert:
        - { description: "The Nextcloud instance should now be 'Stopped'.", path: "find(instanceDB, { name: 'nextcloud-main' }).status", should: "equal('Stopped')" }

    - stage: 3
      description: "Send reboot command to engine-2."
      manualInstruction: null
      action:
        type: "sendCommand"
        targetEngineName: "engine-2"
        command: "reboot"
      assert: [] # No assertions, the engine will be rebooting

    - stage: 4
      description: "Verify engine-2 has rebooted successfully."
      manualInstruction: "Wait for engine-2 to fully reboot (approx. 1 minute). Press Enter to continue."
      action:
        type: "runCommand"
        command: "connect engine-1 engine-2"
      assert:
        - description: "Engine-2's lastBooted property should have been updated."
          path: "system.checkReboot"
          should: "equal(true)"
